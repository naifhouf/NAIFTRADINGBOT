
<!-- index.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NAIF TRADING BOT â€” VIP (Ultra)</title>
<meta name="description" content="Forex/Metals/Crypto/Indices/Oil Signals (UTC+3) â€” NAIF TRADING BOT" />
<meta name="author" content="@najran2015" />
<style>
  :root{
    --bg1:#0f1117; --bg2:#151a24;
    --card: rgba(22,24,34,0.88);
    --border: rgba(255,255,255,0.12);
    --text:#eaeef7; --muted:#a0a7b5;
    --gold:#ffd54f; --accent:#1e88e5; --ok:#3ddc84; --bad:#ff6b6b;
  }
  [data-theme="light"]{
    --bg1:#f5f7fb; --bg2:#eaf0ff;
    --card: rgba(255,255,255,0.86);
    --border: rgba(0,0,0,0.12);
    --text:#111827; --muted:#4b5563;
    --gold:#c69100; --accent:#0b72d2; --ok:#0a7f49; --bad:#c01f1f;
  }
  body{
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:var(--text); font-family:'Segoe UI',Tahoma,sans-serif; margin:0; padding:22px 10px;
  }
  .wm{ position:fixed; inset:0; pointer-events:none; display:flex; align-items:center; justify-content:center; opacity:.08; z-index:0; }
  .wm span{ font-size:10vw; font-weight:900; letter-spacing:4px; text-transform:uppercase; color:#000; filter:contrast(150%) blur(.2px); }
  .wrap{ position:relative; z-index:1; max-width:1024px; margin:0 auto; }
  .brand{ display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:8px }
  .logo{ width:56px; height:56px; border-radius:16px; background: radial-gradient(60% 60% at 20% 20%, #333, #111);
          border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-weight:900; letter-spacing:.5px; user-select:none; cursor:pointer; }
  .logo span{ color:var(--gold); }
  .card{ background-color: var(--card); border:1px solid var(--border); border-radius:18px; padding:18px; margin:14px auto 0; box-shadow:0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04); }
  h1{ font-size:26px; color:var(--gold); margin:6px 0 10px; text-align:center }
  .sub{ color:var(--muted); font-size:14px; text-align:center }
  label{ font-size:14px; color:var(--muted); display:block; margin:6px 0 6px; }
  .row{ display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
  .row>div{ flex:1 }
  input,select,button{ width:100%; padding:12px; font-size:16px; border-radius:12px; border:1px solid var(--border); background:#15161b; color:#fff; outline:none; }
  [data-theme="light"] input,[data-theme="light"] select,[data-theme="light"] button{ background:#ffffff; color:#111; }
  button{ background: linear-gradient(135deg, #1565c0, var(--accent)); border:none; cursor:pointer; }
  button:hover{ filter:brightness(1.06); }
  button.disabled{ background:#3a3a3a; cursor:not-allowed; }
  .result{ margin-top:12px; background:rgba(15,19,32,.9); padding:16px; border-radius:12px; font-size:16px; white-space:pre-line; min-height:160px; border:1px dashed var(--border) }
  [data-theme="light"] .result{ background:#f8fafc; }
  .muted{ color:var(--muted); font-size:13px }
  .clock{ position:fixed; top:8px; right:10px; background:#00000066; padding:6px 10px; border-radius:10px; border:1px solid var(--border); font-family:monospace; font-size:13px; color:#fff; }
  [data-theme="light"] .clock{ background:#00000020; color:#111; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px }
  @media(max-width:760px){ .grid2{grid-template-columns:1fr} }
  .toolbar{ display:flex; gap:10px; justify-content:center; margin-top:6px }
  .colorbox{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
  .swatch{ display:flex; align-items:center; gap:8px }
  .swatch input[type="color"]{ width:42px; height:36px; padding:0; border-radius:10px; border:1px solid var(--border); }
</style>
</head>
<body>
<div class="wm"><span>NAIF TRADING BOT</span></div>
<div class="clock" id="ksaClock">--:--:-- +03</div>

<div class="wrap">
  <!-- Login -->
  <div id="loginCard" class="card">
    <div class="brand"><div class="logo" id="logo"><span>NT</span></div><div><h1>NAIF TRADING BOT â€” VIP</h1><div class="sub">ØµÙØ­Ø© Ù…Ù‚ÙÙ„Ø© â€” Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</div></div></div>
    <div style="margin-top:10px" class="row">
      <div style="flex:2">
        <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</label>
        <input id="pwd" type="password" placeholder="â€¢â€¢â€¢â€¢" />
      </div>
      <div style="flex:1">
        <button id="loginBtn" onclick="unlock()">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </div>
    <div id="loginMsg" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- Main -->
  <div id="main" style="display:none">
    <div class="card">
      <div class="brand"><div class="logo" id="logo2" title="Ø§Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ù„ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ (Ù…Ø®ÙÙŠ)"><span>NT</span></div><div><h1>NAIF TRADING BOT â€” Ø¥Ø´Ø§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h1><div class="sub">RSI + MACD + PriceAction/EMA14 + Trend(EMA50/200) + BBANDS + ADX + ATR%</div></div></div>

      <!-- Theme & colors -->
      <div class="toolbar">
        <button id="themeBtn" onclick="toggleTheme()">ğŸŒ“ Ø§Ù„ÙˆØ¶Ø¹: ØºØ§Ù…Ù‚/ÙØ§ØªØ­</button>
      </div>
      <div class="colorbox">
        <div class="swatch"><label>Accent</label><input type="color" id="cAccent" value="#1e88e5" onchange="setAccent(this.value)" /></div>
        <div class="swatch"><label>Gold</label><input type="color" id="cGold" value="#ffd54f" onchange="setGold(this.value)" /></div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø§Ù„Ø£ØµÙ„</label>
          <select id="pairSelect">
            <option value="" selected disabled>Ø§Ø®ØªØ± Ø£ØµÙ„Ù‹Ø§</option>
            <optgroup label="Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
          <option value="EUR/USD">ğŸ‡ªğŸ‡º EUR / ğŸ‡ºğŸ‡¸ USD â€” EUR/USD</option>
          <option value="GBP/USD">ğŸ‡¬ğŸ‡§ GBP / ğŸ‡ºğŸ‡¸ USD â€” GBP/USD</option>
          <option value="USD/JPY">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¯ğŸ‡µ JPY â€” USD/JPY</option>
          <option value="USD/CHF">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¨ğŸ‡­ CHF â€” USD/CHF</option>
          <option value="USD/CAD">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¨ğŸ‡¦ CAD â€” USD/CAD</option>
          <option value="AUD/USD">ğŸ‡¦ğŸ‡º AUD / ğŸ‡ºğŸ‡¸ USD â€” AUD/USD</option>
          <option value="NZD/USD">ğŸ‡³ğŸ‡¿ NZD / ğŸ‡ºğŸ‡¸ USD â€” NZD/USD</option>
            </optgroup>
            <optgroup label="Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© + CNH/HKD">
          <option value="EUR/GBP">ğŸ‡ªğŸ‡º EUR / ğŸ‡¬ğŸ‡§ GBP â€” EUR/GBP</option>
          <option value="EUR/JPY">ğŸ‡ªğŸ‡º EUR / ğŸ‡¯ğŸ‡µ JPY â€” EUR/JPY</option>
          <option value="GBP/JPY">ğŸ‡¬ğŸ‡§ GBP / ğŸ‡¯ğŸ‡µ JPY â€” GBP/JPY</option>
          <option value="EUR/CHF">ğŸ‡ªğŸ‡º EUR / ğŸ‡¨ğŸ‡­ CHF â€” EUR/CHF</option>
          <option value="CAD/JPY">ğŸ‡¨ğŸ‡¦ CAD / ğŸ‡¯ğŸ‡µ JPY â€” CAD/JPY</option>
          <option value="AUD/JPY">ğŸ‡¦ğŸ‡º AUD / ğŸ‡¯ğŸ‡µ JPY â€” AUD/JPY</option>
          <option value="NZD/JPY">ğŸ‡³ğŸ‡¿ NZD / ğŸ‡¯ğŸ‡µ JPY â€” NZD/JPY</option>
          <option value="GBP/CHF">ğŸ‡¬ğŸ‡§ GBP / ğŸ‡¨ğŸ‡­ CHF â€” GBP/CHF</option>
          <option value="EUR/AUD">ğŸ‡ªğŸ‡º EUR / ğŸ‡¦ğŸ‡º AUD â€” EUR/AUD</option>
          <option value="EUR/CAD">ğŸ‡ªğŸ‡º EUR / ğŸ‡¨ğŸ‡¦ CAD â€” EUR/CAD</option>
          <option value="AUD/CAD">ğŸ‡¦ğŸ‡º AUD / ğŸ‡¨ğŸ‡¦ CAD â€” AUD/CAD</option>
          <option value="AUD/NZD">ğŸ‡¦ğŸ‡º AUD / ğŸ‡³ğŸ‡¿ NZD â€” AUD/NZD</option>
          <option value="CHF/JPY">ğŸ‡¨ğŸ‡­ CHF / ğŸ‡¯ğŸ‡µ JPY â€” CHF/JPY</option>
          <option value="EUR/NZD">ğŸ‡ªğŸ‡º EUR / ğŸ‡³ğŸ‡¿ NZD â€” EUR/NZD</option>
          <option value="GBP/CAD">ğŸ‡¬ğŸ‡§ GBP / ğŸ‡¨ğŸ‡¦ CAD â€” GBP/CAD</option>
          <option value="GBP/AUD">ğŸ‡¬ğŸ‡§ GBP / ğŸ‡¦ğŸ‡º AUD â€” GBP/AUD</option>
          <option value="NZD/CHF">ğŸ‡³ğŸ‡¿ NZD / ğŸ‡¨ğŸ‡­ CHF â€” NZD/CHF</option>
          <option value="USD/SEK">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¸ğŸ‡ª SEK â€” USD/SEK</option>
          <option value="USD/NOK">ğŸ‡ºğŸ‡¸ USD / ğŸ‡³ğŸ‡´ NOK â€” USD/NOK</option>
          <option value="USD/TRY">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¹ğŸ‡· TRY â€” USD/TRY</option>
          <option value="USD/ZAR">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¿ğŸ‡¦ ZAR â€” USD/ZAR</option>
          <option value="USD/CNH">ğŸ‡ºğŸ‡¸ USD / ğŸ‡¨ğŸ‡³ CNH â€” USD/CNH</option>
          <option value="EUR/CNH">ğŸ‡ªğŸ‡º EUR / ğŸ‡¨ğŸ‡³ CNH â€” EUR/CNH</option>
          <option value="USD/HKD">ğŸ‡ºğŸ‡¸ USD / ğŸ‡­ğŸ‡° HKD â€” USD/HKD</option>
          <option value="HKD/JPY">ğŸ‡­ğŸ‡° HKD / ğŸ‡¯ğŸ‡µ JPY â€” HKD/JPY</option>
            </optgroup>
            <optgroup label="Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†">
          <option value="XAU/USD">ğŸ¥‡ XAU / ğŸ‡ºğŸ‡¸ USD â€” XAU/USD</option>
          <option value="XAG/USD">ğŸ¥ˆ XAG / ğŸ‡ºğŸ‡¸ USD â€” XAG/USD</option>
            </optgroup>
            <optgroup label="Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©">
          <option value="BTC/USD">â‚¿ BTC / ğŸ‡ºğŸ‡¸ USD â€” BTC/USD</option>
          <option value="ETH/USD">Î ETH / ğŸ‡ºğŸ‡¸ USD â€” ETH/USD</option>
          <option value="LTC/USD">Å LTC / ğŸ‡ºğŸ‡¸ USD â€” LTC/USD</option>
          <option value="XRP/USD">âœ• XRP / ğŸ‡ºğŸ‡¸ USD â€” XRP/USD</option>
            </optgroup>
            <optgroup label="Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª">
          <option value="SPX">ğŸ‡ºğŸ‡¸ S&P 500 â€” SPX</option>
          <option value="NDX">ğŸ‡ºğŸ‡¸ Nasdaq 100 â€” NDX</option>
          <option value="DJI">ğŸ‡ºğŸ‡¸ Dow 30 â€” DJI</option>
          <option value="DAX">ğŸ‡©ğŸ‡ª DAX 40 â€” DAX</option>
          <option value="FTSE">ğŸ‡¬ğŸ‡§ FTSE 100 â€” FTSE</option>
          <option value="N225">ğŸ‡¯ğŸ‡µ Nikkei 225 â€” N225</option>
          <option value="HSI">ğŸ‡­ğŸ‡° Hang Seng â€” HSI</option>
            </optgroup>
            <optgroup label="Ø§Ù„Ø·Ø§Ù‚Ø© (Ù†ÙØ·)">
          <option value="XTI/USD">XTI XTI / ğŸ‡ºğŸ‡¸ USD â€” XTI/USD</option>
          <option value="XBR/USD">XBR XBR / ğŸ‡ºğŸ‡¸ USD â€” XBR/USD</option>
            </optgroup>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ</label>
          <select id="tfSelect">
            <option value="1min" selected>1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="5min">5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø²Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
          <select id="expSelect">
            <option value="5" selected>5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="1">1 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="3">3 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="10">10 Ø¯Ù‚Ø§Ø¦Ù‚</option>
          </select>
        </div>
        <div>
          <label>ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <select id="preAlertSelect">
            <option value="10" selected>10 Ø«ÙˆØ§Ù†Ù</option>
            <option value="5">5 Ø«ÙˆØ§Ù†Ù</option>
            <option value="0">Ø¨Ø¯ÙˆÙ†</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>ADX Ø§Ù„ÙØªØ±Ø©</label>
          <select id="adxSelect">
            <option value="14" selected>ADX(14)</option>
            <option value="7">ADX(7)</option>
            <option value="20">ADX(20)</option>
          </select>
        </div>
        <div>
          <label>BBANDS k</label>
          <select id="bbkSelect">
            <option value="2.0" selected>k = 2.0</option>
            <option value="2.5">k = 2.5</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Ø¨ÙˆØ§Ø¨Ø© ATR%</label>
          <select id="atrModeSelect">
            <option value="dynamic" selected>Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Ù…Ø¹ Ø§Ù„Ù…ØªÙˆØ³Ø·)</option>
            <option value="tf">Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø·Ø§Ø± (Ø£Ø´Ø¯)</option>
          </select>
        </div>
        <div>
          <label>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
          <select id="entryDelaySelect">
            <option value="0">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠØ© 00 Ø¨Ø§Ù„Ø¶Ø¨Ø·</option>
            <option value="5">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù Ù…Ù† 00</option>
            <option value="10" selected>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù Ù…Ù† 00</option>
            <option value="15">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ 15 Ø«Ø§Ù†ÙŠØ© Ù…Ù† 00</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1"><button id="analyzeBtn" onclick="analyze()">ğŸ” ØªØ­Ù„ÙŠÙ„</button></div>
        <div style="flex:1"><div class="muted" id="quotaBox" style="text-align:center">â€”</div></div>
      </div>

      <div class="result" id="out">ğŸ“Š Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯.</div>
      <div class="muted" style="margin-top:8px; text-align:center">Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© â€” <b>NAIF TRADING BOT</b> â€¢ <b>@najran2015</b></div>
    </div>
  </div>
</div>

<script>
// ===== KSA Clock =====
function updateClock(){
  const now = new Date();
  const sa = new Date(now.toLocaleString('en-US', {timeZone:'Asia/Riyadh'}));
  const pad = n=> String(n).padStart(2,'0');
  document.getElementById('ksaClock').textContent = pad(sa.getHours())+':'+pad(sa.getMinutes())+':'+pad(sa.getSeconds())+' +03';
}
setInterval(updateClock, 1000); updateClock();

// ===== Theme & colors =====
function toggleTheme(){
  const el=document.documentElement;
  el.setAttribute('data-theme', el.getAttribute('data-theme')==='light'?'dark':'light');
}
function setAccent(v){ document.documentElement.style.setProperty('--accent', v); }
function setGold(v){ document.documentElement.style.setProperty('--gold', v); }

// ===== WebAudio simple beeps =====
let audioCtx = null;
function beep(freq=880, ms=120, type='sine'){ try{ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.0001, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.01); o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.05); o.stop(audioCtx.currentTime+0.06); }, ms); }catch(e){} }
function clickSound(){ beep(660, 60, 'square'); }
document.addEventListener('click', ()=>{ try{ if(audioCtx) audioCtx.resume(); }catch(e){} }, {once:true});

// ===== Login with PBKDF2 =====
const LOGIN_SALT_HEX = "2ec74619dfe11c1633341dcf2260387c";
const LOGIN_ITER = 200000;
const LOGIN_EXPECT_HEX = "ef67a2a2764258b6b24177e0ea02dc5bc984754ec93f0d63af04e5b6fbfa6868";

// API recovery (PBKDF2 key XOR)
const API_SALT_HEX = "906dd53c40fc524fde9c520e38cbae2d";
const API_ITER = 200000;
const API_OBF_HEX = "88bc4044526cb6415315f6ebcf630e981941a45c40fec453b701a668a4b2da91";
let API_KEY = null;

async function pbkdf2Hex(pwd, saltHex, iter){
  const enc = new TextEncoder();
  const mat = await crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveBits']);
  const salt = hexToBytes(saltHex);
  const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:iter, hash:'SHA-256'}, mat, 256);
  return buf2hex(bits);
}
async function pbkdf2Raw(pwd, saltHex, iter){
  const enc = new TextEncoder();
  const mat = await crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveBits']);
  const salt = hexToBytes(saltHex);
  const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations:iter, hash:'SHA-256'}, mat, 256);
  return new Uint8Array(bits);
}
function hexToBytes(hex){ const arr = new Uint8Array(hex.length/2); for(let i=0;i<arr.length;i++) arr[i]=parseInt(hex.substr(i*2,2),16); return arr; }
function buf2hex(buf){ const b = new Uint8Array(buf); let s=''; for(let i=0;i<b.length;i++) s+=b[i].toString(16).padStart(2,'0'); return s; }

async function unlock(){
  clickSound();
  const input=(document.getElementById('pwd').value||'').trim();
  const msg=document.getElementById('loginMsg');
  if(!input){ msg.innerHTML='<span class="bad">âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ.</span>'; return; }
  msg.textContent='âŒ› Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
  try{
    const hex=await pbkdf2Hex(input, LOGIN_SALT_HEX, LOGIN_ITER);
    if(hex===LOGIN_EXPECT_HEX){
      const keyBytes=await pbkdf2Raw(input, API_SALT_HEX, API_ITER);
      const obf=hexToBytes(API_OBF_HEX);
      let plain=new Uint8Array(obf.length);
      for(let i=0;i<obf.length;i++) plain[i]=obf[i]^keyBytes[i%keyBytes.length];
      API_KEY=new TextDecoder().decode(plain);

      document.getElementById('loginCard').style.display='none';
      document.getElementById('main').style.display='block';
      msg.innerHTML='<span class="ok">âœ… ØªÙ… ÙØªØ­ Ø§Ù„ØµÙØ­Ø©.</span>';
      updateQuotaUI();
    } else { msg.innerHTML='<span class="bad">âŒ ØºÙŠØ± ØµØ­ÙŠØ­.</span>'; }
  }catch(e){ msg.innerHTML='<span class="bad">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</span>'; }
}

// ===== Hidden reset: double-click logo or Ctrl+Alt+R =====
document.getElementById('logo2').addEventListener('dblclick', ()=>{ if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù„Ù„ÙŠÙˆÙ…ØŸ')) resetDaily(); });
document.addEventListener('keydown', e=>{ if(e.ctrlKey && e.altKey && (e.key==='r' || e.key==='R')){ if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù„Ù„ÙŠÙˆÙ…ØŸ')) resetDaily(); } });

// ===== Quota/Cooldown =====
const QUOTA_MAX=30, COOLDOWN_MS=5*60*1000; const KEY='NAIF_QUOTA';
const STORE={date:'',count:0,last_ts:0};
function todayStr(){ const sa=new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Riyadh'})); return sa.toISOString().slice(0,10); }
function loadQuota(){ try{ const o=JSON.parse(localStorage.getItem(KEY)||'null'); if(o) return o; }catch(e){} return {...STORE}; }
function saveQuota(o){ localStorage.setItem(KEY, JSON.stringify(o)); }
function resetDaily(){ const o={...STORE, date:todayStr(), count:0, last_ts:0}; saveQuota(o); updateQuotaUI(); clickSound(); document.getElementById('out').textContent='âœ… ØªÙ… ØªØµÙÙŠØ± Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ….'; }
function updateQuotaUI(){ let o=loadQuota(); const t=todayStr(); if(o.date!==t) o={...STORE, date:t}; const next=Math.max(0,(o.last_ts+COOLDOWN_MS)-Date.now()); const m=Math.floor(next/60000), s=Math.floor((next%60000)/1000); const rest=next>0?` | Ø§Ù†ØªØ¸Ø§Ø±: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:''; document.getElementById('quotaBox').textContent=`Ø§Ù„ÙŠÙˆÙ…: ${o.count} / 30${rest}`; } setInterval(updateQuotaUI,1000);

// ===== Indicators =====
function sma(a,p){ if(a.length<p) return a.map(_=>a[0]); let out=[],sum=0; for(let i=0;i<a.length;i++){ sum+=a[i]; if(i>=p) sum-=a[i-p]; out.push(i>=p-1? sum/p : a[i]); } return out; }
function ema(a,p){ const k=2/(p+1); let out=[],prev=a[0]; for(let i=0;i<a.length;i++){ const v=a[i]; if(i===0) out.push(prev); else { prev=v*k+prev*(1-k); out.push(prev); } } return out; }
function rsi(c,p=14){ let g=[],l=[]; for(let i=1;i<c.length;i++){ const d=c[i]-c[i-1]; g.push(Math.max(0,d)); l.push(Math.max(0,-d)); } const a=1/p; let G=0,L=0; let out=Array(c.length).fill(50); for(let i=0;i<g.length;i++){ G=a*g[i]+(1-a)*G; L=a*l[i]+(1-a)*L; const rs=L===0?99:G/L; out[i+1]=100-(100/(1+rs)); } return out; }
function macd(c, f=12, s=26, sig=9){ const ef=ema(c,f), es=ema(c,s); const line=c.map((_,i)=>ef[i]-es[i]); const sg=ema(line,sig); const h=line.map((v,i)=>v-sg[i]); return {line:line,sig:sg,hist:h}; }
function atr(h,l,c,p=14){ let trs=[]; for(let i=1;i<c.length;i++){ const tr=Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])); trs.push(tr); } const a=1/p; let out=[...Array(c.length).fill(0)], avg=0; for(let i=0;i<trs.length;i++){ avg=a*trs[i]+(1-a)*avg; out[i+1]=avg; } return out; }
function adx(h,l,c,p=14){ const n=h.length; let pDM=Array(n).fill(0), mDM=Array(n).fill(0), TR=Array(n).fill(0); for(let i=1;i<n;i++){ const up=h[i]-h[i-1]; const dn=l[i-1]-l[i]; pDM[i]=(up>dn&&up>0)?up:0; mDM[i]=(dn>up&&dn>0)?dn:0; TR[i]=Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1])); } function smooth(arr){ const out=Array(n).fill(0); let s=0; for(let i=1;i<=p&&i<n;i++) s+=arr[i]; out[p]=s; for(let i=p+1;i<n;i++) out[i]=out[i-1]-out[i-1]/p+arr[i]; return out; } const trS=smooth(TR), pS=smooth(pDM), mS=smooth(mDM); let pDI=Array(n).fill(0), mDI=Array(n).fill(0), DX=Array(n).fill(0); for(let i=p;i<n;i++){ pDI[i]=100*(pS[i]/trS[i]); mDI[i]=100*(mS[i]/trS[i]); DX[i]=100*Math.abs(pDI[i]-mDI[i])/(pDI[i]+mDI[i]||1); } const adxArr=Array(n).fill(0); let sumDX=0; for(let i=p;i<p*2&&i<n;i++) sumDX+=DX[i]; adxArr[p*2-1]=sumDX/p; for(let i=p*2;i<n;i++) adxArr[i]=(adxArr[i-1]*(p-1)+DX[i])/p; return {plusDI:pDI, minusDI:mDI, ADX:adxArr}; }
function bbands(c,period=20,k=2){ const mid=sma(c,period); let up=[],low=[]; for(let i=0;i<c.length;i++){ const st=Math.max(0,i-period+1); const win=c.slice(st,i+1); const m=mid[i]; const v=win.reduce((a,x)=>a+(x-m)*(x-m),0)/Math.max(1,win.length); const sd=Math.sqrt(v); up.push(m+k*sd); low.push(m-k*sd); } return {mid,up,low}; }

// ===== Data fetch =====
async function fetchSeries(symbol, interval, outputsize=240){
  const url = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=${interval}&outputsize=${outputsize}&format=JSON&apikey=${encodeURIComponent(API_KEY)}`;
  const r = await fetch(url, {cache:'no-store'});
  const j = await r.json();
  if(j.status==='error') throw new Error(j.message||'API error');
  const values=(j.values||[]).slice().reverse(); if(values.length<80) throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
  const opens=values.map(v=>+v.open), highs=values.map(v=>+v.high), lows=values.map(v=>+v.low), closes=values.map(v=>+v.close);
  return {opens,highs,lows,closes,meta:j.meta};
}

// ===== Decision =====
function decide(opens,highs,lows,closes, bbK=2.0, adxP=14, atrMode='dynamic', tf='1min'){
  const i=closes.length-1;
  const ema14=ema(closes,14), ema50=ema(closes,50), ema200=ema(closes,200);
  const rsiArr=rsi(closes,14); const mac=macd(closes);
  const atrArr=atr(highs,lows,closes,14);
  const bb=bbands(closes,20,bbK); const ax=adx(highs,lows,closes,adxP);

  const price=closes[i]; const rsiV=rsiArr[i]; const hist=mac.hist[i];
  const pa=(price>ema14[i] && price>opens[i])?'CALL':(price<ema14[i] && price<opens[i])?'PUT':'NEUTRAL';
  const trend=ema50[i]>ema200[i]?'UP':'DOWN';

  // ATR%
  const atrp=(atrArr[i]/price)*100;
  const atrpSeries=atrArr.map((a,idx)=> (a/Math.max(1e-9,closes[idx]))*100 );
  const atrpAvg=sma(atrpSeries,20)[i];
  let atrOk=false;
  if(atrMode==='tf'){
    const tfMin={'1min':0.03,'5min':0.06}[tf]||0.03; // percent
    atrOk = atrp >= tfMin;
  } else {
    atrOk = atrp >= Math.max(0.02, atrpAvg*0.85);
  }

  const bbVote = price <= bb.low[i] ? 'CALL' : price >= bb.up[i] ? 'PUT' : 'NEUTRAL';
  const rsiVote = rsiV<=30?'CALL': rsiV>=70?'PUT':'NEUTRAL';
  const macVote = hist>0?'CALL':'PUT';
  const trendVote = trend==='UP'?'CALL':'PUT';

  const adxV = ax.ADX[i]; const adxOk = adxV>=18;
  const votes=[rsiVote, macVote, pa, trendVote, bbVote];
  const callVotes=votes.filter(v=>v==='CALL').length, putVotes=votes.filter(v=>v==='PUT').length;

  let direction='NEUTRAL', confidence=50;
  if(atrOk && adxOk){ if(callVotes>=3){ direction='CALL'; confidence = callVotes>=4? 92: 80; } else if(putVotes>=3){ direction='PUT'; confidence = putVotes>=4? 92: 80; } }
  return {direction, confidence, details:{rsi:rsiV, macd_hist:hist, pa, trend, bbVote, bbLow:bb.low[i], bbUp:bb.up[i], atrp, atrpAvg, atrOk, adx:adxV, adxOk, votes, bbK, adxP, atrMode} };
}

// ===== Pre-entry beeps (countdown) =====
let countdownTimer=null;
function schedulePreAlert(entryTs, preSec){
  clearInterval(countdownTimer);
  if(preSec<=0) return;
  countdownTimer=setInterval(()=>{
    const now=Date.now(); const diff=Math.floor((entryTs-now)/1000);
    if(diff<=0){ clearInterval(countdownTimer); beep(880,160,'sawtooth'); return; }
    if(diff<=preSec) beep(880-(preSec-diff)*20, 90, 'square');
  },1000);
}

// ===== Analyze =====
async function analyze(){
  clickSound();
  if(!API_KEY){ alert('Ù„Ø³Øª Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„'); return; }
  let o=loadQuota(); const t=todayStr(); if(o.date!==t) o={ date:t, count:0, last_ts:0 };
  if(o.count>=30){ document.getElementById('out').textContent='âŒ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ (30 ØµÙÙ‚Ø©)'; return; }
  const remain=(o.last_ts+5*60*1000)-Date.now(); if(remain>0){ const mm=Math.floor(remain/60000), ss=Math.floor((remain%60000)/1000); document.getElementById('out').textContent='â³ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± '+String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0')+' Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.'; return; }

  const pairEl=document.getElementById('pairSelect');
  const pair=pairEl.value;
  const pairLabel=pairEl.options[pairEl.selectedIndex].text;
  const tf=document.getElementById('tfSelect').value;
  const exp=parseInt(document.getElementById('expSelect').value||'5',10);
  const preSec=parseInt(document.getElementById('preAlertSelect').value||'10',10);
  const adxP=parseInt(document.getElementById('adxSelect').value||'14',10);
  const bbK=parseFloat(document.getElementById('bbkSelect').value||'2.0');
  const atrMode=document.getElementById('atrModeSelect').value;
  const entryDelay=parseInt(document.getElementById('entryDelaySelect').value||'10',10);

  const out=document.getElementById('out');
  if(!pair){ alert('Ø§Ø®ØªØ± Ø£ØµÙ„Ù‹Ø§'); return; }
  out.textContent='â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';

  let symbol=pair;
  if(pair==='GOLD/USD') symbol='XAU/USD';

  try{
    const s=await fetchSeries(symbol, tf, 360);
    const d=decide(s.opens,s.highs,s.lows,s.closes, bbK, adxP, atrMode, tf);
    const saNow=new Date(new Date().toLocaleString('en-US', {timeZone:'Asia/Riyadh'}));
    const entry=new Date(saNow.getTime());
    entry.setMinutes(entry.getMinutes()+1); entry.setSeconds(0); entry.setMilliseconds(0);
    entry.setSeconds(entry.getSeconds()+entryDelay); // delay after 00
    const mg1=new Date(entry.getTime()+exp*60000), mg2=new Date(entry.getTime()+exp*120000);
    const fmt=dt=> dt.toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Asia/Riyadh'});
    const today=saNow.toLocaleDateString('ar-EG', {year:'numeric',month:'2-digit',day:'2-digit',timeZone:'Asia/Riyadh'});

    if(d.direction==='NEUTRAL'){
      out.textContent = `â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø© Ù…Ø¤ÙƒØ¯Ø© Ø§Ù„Ø¢Ù† (Ù„Ù… ØªØªØ­Ù‚Ù‚ Ø§Ù„Ø´Ø±ÙˆØ·).
Ø§Ù„Ø£ØµÙ„: ${pairLabel}
Ø§Ù„Ø¥Ø·Ø§Ø±: ${tf}
Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ADX(${d.details.adxP}) â€¢ BB k=${d.details.bbK} â€¢ ATR=${d.details.atrMode}
ATR%: ${d.details.atrp.toFixed(3)} (Ù…ØªÙˆØ³Ø·: ${d.details.atrpAvg.toFixed(3)}) â€” ATR OK: ${d.details.atrOk?'âœ…':'âŒ'}
ADX: ${d.details.adx.toFixed(2)} â€” ADX OK: ${d.details.adxOk?'âœ…':'âŒ'}
Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today} ğŸ‡¸ğŸ‡¦`;
      return;
    }

    const dirIcon = d.direction==='CALL' ? 'ğŸŸ© Ø´Ø±Ø§Ø¡' : 'ğŸŸ¥ Ø¨ÙŠØ¹';
    out.textContent = `${pairLabel}
ğŸ•˜ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ${exp} Ø¯Ù‚Ø§Ø¦Ù‚
âºï¸ Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ${fmt(entry)}
${dirIcon}

ğŸ“Š Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª (3 Ù…Ù† 5) + ATR% + ADX:
â€¢ RSI(14): ${d.details.rsi.toFixed(2)} â†’ ${d.details.rsi<=30?'CALL': d.details.rsi>=70?'PUT':'Ù…Ø­Ø§ÙŠØ¯'}
â€¢ MACD hist: ${d.details.macd_hist.toFixed(5)} â†’ ${d.details.macd_hist>0?'CALL':'PUT'}
â€¢ Price Action/EMA14: ${d.details.pa}
â€¢ Trend EMA(50/200): ${d.details.trend==='UP'?'CALL':'PUT'}
â€¢ BBANDS(20, ${d.details.bbK}): ${d.details.bbVote}
â€¢ ATR%: ${d.details.atrp.toFixed(3)} (Ù…ØªÙˆØ³Ø· 20: ${d.details.atrpAvg.toFixed(3)}) â†’ ${d.details.atrOk?'âœ… OK':'âŒ Ù…Ù†Ø®ÙØ¶'}
â€¢ ADX(${d.details.adxP}): ${d.details.adx.toFixed(2)} â†’ ${d.details.adxOk?'âœ… Ù‚ÙˆÙŠ':'âŒ Ø¶Ø¹ÙŠÙ'}

âœ… Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©: ${d.confidence}%

ğŸ›¡ï¸ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ©:
1ï¸âƒ£ ${fmt(mg1)}
2ï¸âƒ£ ${fmt(mg2)}

ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${today} ğŸ‡¸ğŸ‡¦`;

    // success -> quota & cooldown, schedule pre-alert beeps
    o.count+=1; o.last_ts=Date.now(); saveQuota(o); updateQuotaUI();
    schedulePreAlert(entry.getTime(), preSec);

  }catch(e){ out.textContent='âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: '+e.message; }
}

// ===== Prevent easy inspection (best-effort) =====
document.addEventListener('contextmenu', e=>e.preventDefault());
document.addEventListener('keydown', e=>{ const k=e.key?.toLowerCase(); if((e.ctrlKey&&(k==='u'||k==='s'||k==='p'||k==='j'))||(e.key==='F12')) e.preventDefault(); });
</script>
</body>
</html>

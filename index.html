<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NAIF TRADING BOT — VIP Signals</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='1' y2='0'%3E%3Cstop stop-color='%2300E5A8'/%3E%3Cstop stop-color='%2338BDF8' offset='1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='128' height='128' rx='22' fill='%23111827'/%3E%3Cpath d='M24 88l40-70 40 70H24z' fill='url(%23g)'/%3E%3Ctext x='64' y='98' text-anchor='middle' font-family='Verdana' font-size='20' fill='%23F8FAFC'%3ENTB%3C/text%3E%3C/svg%3E" />
<style>
  :root {
    --primary: #00E5A8;
    --accent: #38BDF8;
    --warning: #F59E0B;
    --danger: #EF4444;
    --success: #22C55E;
    --surface-1: #111827;
    --surface-2: #0F172A;
    --surface-3: #1E293B;
    --glass: rgba(17, 24, 39, 0.8);
    --text-high: #F8FAFC;
    --text-medium: #E2E8F0;
    --text-low: #94A3B8;
    --radius-sm: 8px;
    --radius-md: 14px;
    --radius-lg: 20px;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 16px 64px rgba(0, 0, 0, 0.4);
    --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
  }
  * { box-sizing: border-box; }
  /* Anti-select baseline */
  html, body, * {
    -webkit-user-select: none; -ms-user-select: none; user-select: none;
  }
  body {
    font-family: 'Cairo', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, var(--surface-2) 0%, #0C1222 100%);
    color: var(--text-high);
    margin: 0;
    padding: 0;
    min-height: 100vh;
    direction: rtl;
    overflow-x: hidden;
  }
  .vip-header {
    background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
    padding: 12px 16px;
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 12px;
    align-items: center;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .vip-logo {
    display: flex; align-items: center; gap: 10px;
    font-weight: 800; color: #fff;
  }
  .vip-logo svg { width: 36px; height: 36px; filter: drop-shadow(0 2px 8px rgba(0,0,0,.25)); }
  .vip-logo .title { font-size: 20px; letter-spacing: .2px; }
  .vip-logo .subtitle { font-size: 12px; opacity: .9; font-weight: 600; }
  .vip-status { display: flex; gap: 10px; align-items: center; justify-content: flex-end; }
  .status-pill {
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(12px);
    padding: 8px 12px;
    border-radius: var(--radius-lg);
    font-size: 13px; font-weight: 700; color: white;
    border: 1px solid rgba(255,255,255,0.1);
    white-space: nowrap;
  }
  .status-pill.active { background: rgba(34, 197, 94, 0.3); border-color: var(--success); }
  .status-pill.expired { background: rgba(239, 68, 68, 0.3); border-color: var(--danger); }
  .clock { background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.15); padding: 6px 10px; border-radius: 999px; font-size: 12px; }
  .audio-toggle {
    background: rgba(255, 255, 255, 0.18);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 50%;
    width: 38px; height: 38px;
    display: grid; place-items: center;
    cursor: pointer; transition: var(--transition); color: #fff;
  }
  .audio-toggle.enabled { background: var(--success); border-color: var(--success); }
  .vip-activation {
    background: linear-gradient(135deg, var(--surface-3), #111827);
    color: white; border: 1px solid rgba(255,255,255,.2); border-radius: 12px;
    padding: 10px 16px; font-size: 13px; font-weight: 700; cursor: pointer; transition: var(--transition);
  }
  .vip-activation:hover { transform: translateY(-1px); }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; gap: 20px; }
  .hero-section {
    text-align: center; padding: 28px; background: var(--glass); backdrop-filter: blur(20px);
    border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--shadow-lg);
  }
  .hero-title {
    font-size: 28px; font-weight: 900;
    background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    margin: 0 0 10px 0;
  }
  .hero-subtitle { color: var(--text-medium); font-size: 16px; margin: 0 0 18px 0; }
  .controls-section { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center; margin-top: 10px; }
  .vip-select {
    background: var(--surface-3); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius-md);
    padding: 14px 18px; color: var(--text-high); font-size: 16px; font-weight: 700; transition: var(--transition); outline: none; width: 100%;
  }
  .vip-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,229,168,.2); transform: translateY(-1px); }
  .vip-select:disabled { opacity: .6; cursor: not-allowed; transform: none; }
  .vip-btn {
    position: relative; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; border-radius: var(--radius-md);
    padding: 14px 28px; color: white; font-size: 15px; font-weight: 800; cursor: pointer; transition: var(--transition);
    overflow: hidden; box-shadow: var(--shadow-md); min-width: 160px;
  }
  .vip-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 12px 48px rgba(0,229,168,0.4); }
  .vip-btn:disabled { opacity: .6; cursor: not-allowed; }
  .btn-spinner { position: absolute; inset: 0; display: grid; place-items: center; opacity: 0; transition: var(--transition); }
  .vip-btn.loading .btn-spinner { opacity: 1; }
  .vip-btn.loading .btn-text { opacity: 0; }
  .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .cards-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .vip-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg); padding: 20px; box-shadow: var(--shadow-md); transition: var(--transition); }
  .vip-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: rgba(255,255,255,0.2); }
  .card-title { font-size: 18px; font-weight: 800; color: var(--text-high); margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
  .card-icon { width: 22px; height: 22px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: grid; place-items: center; font-size: 13px; }
  .signal-card { min-height: 200px; transition: var(--transition); }
  .signal-card.buy { border: 2px solid var(--success); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); }
  .signal-card.sell { border: 2px solid var(--danger); background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); }
  .signal-content { white-space: pre-line; line-height: 1.6; color: var(--text-medium); }
  .signal-actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
  .copy-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius-sm); padding: 8px 12px; color: var(--text-medium); font-size: 12px; cursor: pointer; transition: var(--transition); }
  .copy-btn:hover { background: rgba(255,255,255,0.2); color: var(--text-high); }
  .widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 12px; }
  .widget-card { background: var(--surface-3); border-radius: var(--radius-lg); padding: 18px; box-shadow: var(--shadow-sm); border: 1px solid rgba(255,255,255,0.05); }
  .vip-activation-2 { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; border-radius: var(--radius-md); padding: 10px 20px; font-size: 14px; font-weight: 800; cursor: pointer; transition: var(--transition); }
  .vip-activation-2:hover { transform: scale(1.03); box-shadow: 0 8px 24px rgba(0, 229, 168, 0.3); }
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; }
  .modal.show { display: flex; }
  .modal-content { background: var(--surface-1); border-radius: var(--radius-lg); padding: 28px; max-width: 420px; width: 92%; border: 1px solid rgba(255,255,255,0.1); box-shadow: var(--shadow-lg); animation: modalSlideIn 0.3s ease-out; }
  @keyframes modalSlideIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
  .modal-title { font-size: 22px; font-weight: 900; margin-bottom: 12px; text-align: center; color: var(--text-high); }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-weight: 700; margin-bottom: 6px; color: var(--text-medium); }
  .form-input { width: 100%; background: var(--surface-3); border: 2px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); padding: 12px 14px; color: var(--text-high); font-size: 16px; transition: var(--transition); outline: none; }
  .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 229, 168, 0.2); }
  .toast { position: fixed; top: 20px; right: 20px; background: var(--surface-1); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-md); padding: 14px 16px; box-shadow: var(--shadow-lg); z-index: 1100; transform: translateX(400px); transition: var(--transition); max-width: 350px; }
  .toast.show { transform: translateX(0); }
  .toast.success { border-color: var(--success); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); }
  .toast.error { border-color: var(--danger); background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); }
  .signal-notification { position: fixed; top: 80px; right: 20px; background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--primary); border-radius: var(--radius-md); padding: 14px; max-width: 300px; z-index: 1000; transform: translateX(400px); transition: var(--transition); box-shadow: var(--shadow-lg); }
  .signal-notification.show { transform: translateX(0); }
  /* Password Gate */
  .gate { position: fixed; inset: 0; z-index: 2000; display: grid; place-items: center; background: radial-gradient(1200px 800px at 50% 30%, rgba(56,189,248,.15), rgba(0,0,0,.85)); backdrop-filter: blur(6px); }
  .gate-card { width: min(440px, 92vw); background: var(--surface-1); border: 1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 22px; box-shadow: var(--shadow-lg); text-align: center; }
  .gate-logo { margin-bottom: 10px; }
  .gate-title { font-weight: 900; margin: 8px 0 4px; }
  .gate-sub { color: var(--text-medium); font-size: 14px; margin: 0 0 14px; }
  .gate-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; }
  .gate-input { width: 100%; background: var(--surface-3); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px 14px; color: var(--text-high); font-size: 16px; outline: none; }
  .gate-btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; border: none; border-radius: 12px; padding: 12px 16px; font-weight: 900; cursor: pointer; }
  .gate-meta { margin-top: 12px; font-size: 12px; color: var(--text-low); }
  /* Mobile */
  @media (max-width: 768px) {
    .cards-grid { grid-template-columns: 1fr; }
    .controls-section { grid-template-columns: 1fr; gap: 10px; }
    .vip-header { grid-template-columns: 1fr auto; }
    .vip-logo .title { font-size: 18px; }
  }
</style>
</head>
<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">
  <!-- VIP Header -->
  <header class="vip-header">
    <div class="vip-logo">
      <!-- Inline SVG logo -->
      <svg viewBox="0 0 128 128" aria-hidden="true">
        <defs><linearGradient id="g2" x1="0" x2="1" y1="1" y2="0"><stop stop-color="#00E5A8"/><stop offset="1" stop-color="#38BDF8"/></linearGradient></defs>
        <rect width="128" height="128" rx="26" fill="#0b1324"/>
        <path d="M24 92 64 22 104 92H24z" fill="url(#g2)"/>
        <text x="64" y="102" text-anchor="middle" font-family="Verdana" font-size="18" fill="#F8FAFC">NAIF</text>
      </svg>
      <div>
        <div class="title">NAIF TRADING BOT — VIP Signals</div>
        <div class="subtitle">@najran2015</div>
      </div>
    </div>
    <div class="vip-status">
      <div class="clock" id="ksaClock">—</div>
      <div class="status-pill active" id="vipStatus">🔥 VIP نشط</div>
      <button class="audio-toggle" id="audioToggle" title="تشغيل/إيقاف الأصوات">🔊</button>
      <button class="vip-activation" id="activateBtn">🎫 تفعيل كود</button>
    </div>
  </header>

  <div class="container">
    <!-- Hero Section -->
    <section class="hero-section">
      <h1 class="hero-title">🎯 منصة التداول الاحترافية</h1>
      <p class="hero-subtitle">احصل على إشارات تداول دقيقة ومتقدمة — تم الإعداد بواسطة <strong>@najran2015</strong></p>
      <div class="controls-section">
        <select id="pairSelect" class="vip-select">
          <option value="EUR/USD">💶 EUR/USD - اليورو دولار</option>
          <option value="GBP/USD">💷 GBP/USD - الباوند دولار</option>
          <option value="USD/JPY">💴 USD/JPY - الدولار ين</option>
          <option value="XAU/USD" selected>🥇 XAU/USD - الذهب</option>
          <option value="USD/CHF">🇨🇭 USD/CHF - الدولار فرنك</option>
          <option value="USD/CAD">🇨🇦 USD/CAD - الدولار كندي</option>
          <option value="AUD/USD">🇦🇺 AUD/USD - الاسترالي دولار</option>
          <option value="NZD/USD">🇳🇿 NZD/USD - النيوزيلندي دولار</option>
          <option value="EUR/JPY">🇪🇺 EUR/JPY - اليورو ين</option>
          <option value="GBP/JPY">🇬🇧 GBP/JPY - الباوند ين</option>
          <option value="EUR/GBP">🇪🇺 EUR/GBP - اليورو باوند</option>
          <option value="BTC/USDT">₿ BTC/USDT - البيتكوين</option>
        </select>
        <button id="analyzeBtn" class="vip-btn">
          <span class="btn-text">🚀 تحليل احترافي</span>
          <div class="btn-spinner"><div class="spinner"></div></div>
        </button>
      </div>
    </section>

    <!-- Cards Grid -->
    <div class="cards-grid">
      <div class="vip-card">
        <div class="card-title">
          <div class="card-icon">📊</div>
          نتيجة التحليل
        </div>
        <div id="result" class="signal-content">✨ اختر الزوج واضغط تحليل للحصول على إشارة احترافية</div>
      </div>

      <div class="vip-card signal-card" id="recommendationBox">
        <div class="card-title">
          <div class="card-icon">🎯</div>
          التوصية المتقدمة
        </div>
        <div id="signalContent" class="signal-content">🔮 في انتظار التحليل الاحترافي...</div>
        <div class="signal-actions" id="signalActions" style="display:none;">
          <button class="copy-btn" onclick="copyToClipboard('entry')">📋 نسخ الدخول</button>
          <button class="copy-btn" onclick="copyToClipboard('target')">🎯 نسخ الهدف</button>
          <button class="copy-btn" onclick="copyToClipboard('stop')">🛑 نسخ الإيقاف</button>
          <a class="copy-btn" href="https://t.me/najran2015" target="_blank" rel="noopener">📨 تواصل @najran2015</a>
          <button class="copy-btn" onclick="shareSignal()">📤 مشاركة</button>
        </div>
      </div>
    </div>

    <!-- TradingView Widgets -->
    <div class="widgets">
      <div class="widget-card"><div id="tv-ta"></div></div>
      <div class="widget-card"><div id="tv-news"></div></div>
      <div class="widget-card"><div id="tv-tape"></div></div>
    </div>
  </div>

  <!-- VIP Activation Modal -->
  <div class="modal" id="activationModal">
    <div class="modal-content">
      <h2 class="modal-title">🎫 تفعيل العضوية VIP</h2>
      <form id="activationForm">
        <div class="form-group">
          <label class="form-label">كود التفعيل</label>
          <input type="text" class="form-input" id="codeInput" placeholder="أدخل كود VIP الخاص بك" maxlength="20" autocomplete="off">
        </div>
        <div class="form-group"><button type="submit" class="vip-activation-2" style="width:100%;">✨ تفعيل العضوية</button></div>
        <div class="form-group"><button type="button" class="copy-btn" onclick="closeModal()" style="width:100%; padding:12px;">❌ إلغاء</button></div>
      </form>
    </div>
  </div>

  <!-- Password Gate -->
  <div class="gate" id="pwdGate" style="display:none;">
    <div class="gate-card">
      <div class="gate-logo">
        <svg viewBox="0 0 128 128" width="56" height="56">
          <defs><linearGradient id="g3" x1="0" x2="1" y1="1" y2="0"><stop stop-color="#00E5A8"/><stop offset="1" stop-color="#38BDF8"/></linearGradient></defs>
          <rect width="128" height="128" rx="26" fill="#0b1324"/>
          <path d="M24 92 64 22 104 92H24z" fill="url(#g3)"/>
        </svg>
      </div>
      <h3 class="gate-title">حماية الوصول</h3>
      <p class="gate-sub">الرجاء إدخال كلمة السر للوصول إلى الصفحة</p>
      <div class="gate-row">
        <input type="password" inputmode="text" autocomplete="off" class="gate-input" id="gatePwd" placeholder="كلمة السر" />
        <button class="gate-btn" id="gateBtn">دخول</button>
      </div>
      <div class="gate-meta">تلميح: الكلمة مكونة من 4 أحرف (مخصصة لمالك الصفحة)</div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>
  <div id="signalNotification" class="signal-notification"><div id="notificationContent"></div></div>

<script>
/* ========= Secure-ish helpers (simple obfuscation & anti-copy) ========= */
(function(){
  // Block common shortcuts (Ctrl/Cmd+U, S, C, I, J, P, F12)
  document.addEventListener('keydown', function(e){
    const k = e.key.toLowerCase();
    if ((e.ctrlKey || e.metaKey) && ['u','s','c','p','i','j'].includes(k)) { e.preventDefault(); e.stopPropagation(); }
    if (e.ctrlKey && e.shiftKey && ['i','j','c'].includes(k)) { e.preventDefault(); e.stopPropagation(); }
    if (e.key === 'F12') { e.preventDefault(); e.stopPropagation(); }
  }, true);
  // Drag & selection already disabled via attributes/CSS; also block copy
  ['copy','cut','paste','contextmenu'].forEach(evt => document.addEventListener(evt, e => e.preventDefault(), true));
})();

/* ========= Live KSA Clock ========= */
function updateKSAClock(){
  try{
    const el = document.getElementById('ksaClock');
    if(!el) return;
    const now = new Date().toLocaleString('ar-SA', { hour12: false, timeZone: 'Asia/Riyadh' });
    el.textContent = '🕒 الرياض (UTC+3): ' + now;
  }catch(_){}
}
setInterval(updateKSAClock, 1000);
updateKSAClock();

/* ========= Audio System ========= */
let audioEnabled = localStorage.getItem('vip-audio') !== 'false';
let audioContext;
function initAudioSystem() {
  updateAudioToggle();
  document.addEventListener('click', function initAudio() {
    if (!audioContext) {
      try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) {}
    }
    document.removeEventListener('click', initAudio);
  }, { once: true });
}
function toggleAudio() {
  audioEnabled = !audioEnabled; localStorage.setItem('vip-audio', audioEnabled); updateAudioToggle();
  if (audioEnabled) { playNotificationSound('success'); showToast('🔊 تم تفعيل الأصوات', 'success'); }
  else { showToast('🔇 تم إيقاف الأصوات', 'error'); }
}
function updateAudioToggle() {
  const t = document.getElementById('audioToggle');
  if (!t) return;
  t.textContent = audioEnabled ? '🔊' : '🔇';
  t.classList.toggle('enabled', audioEnabled);
  t.title = audioEnabled ? 'إيقاف الأصوات' : 'تشغيل الأصوات';
}
function playNotificationSound(type = 'info') {
  if (!audioEnabled) return;
  try {
    if (audioContext) {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain); gain.connect(audioContext.destination);
      const freqMap = {'success':[523,659,784],'error':[392,311],'info':[659,523],'warning':[523,440]};
      const seq = freqMap[type] || freqMap['info']; let t = audioContext.currentTime;
      seq.forEach((f,i)=>osc.frequency.setValueAtTime(f, t + i*0.1));
      gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.08, t+0.01); gain.gain.exponentialRampToValueAtTime(0.001, t+0.3);
      osc.start(t); osc.stop(t+0.3);
    } else {
      const a = new Audio(); a.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N+QQAoUXrTp66hVFApGn+DyvmEUExqLzezlhTYcFWqvx+OsYRMuR5ztxHMdGBhklefN'; a.volume=.3; a.play().catch(()=>{});
    }
  } catch(_) {}
}
function showSignalNotification(signal) {
  if (!signal) return;
  const notification = document.getElementById('signalNotification');
  const content = document.getElementById('notificationContent');
  if (!notification || !content) return;
  const directionEmoji = signal.direction === 'شراء' ? '📈' : '📉';
  const confidenceColor = signal.confidence >= 85 ? '#22C55E' : '#F59E0B';
  content.innerHTML = `
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="font-size:20px;">${signal.emoji||'🎯'}</span>
      <strong>${signal.name||'إشارة جديدة'}</strong>
      <span style="color:${confidenceColor};">${signal.confidence||80}%</span>
    </div>
    <div style="color:var(--text-medium);font-size:14px;">
      ${directionEmoji} ${signal.direction} - ${(signal.news||'').substring(0,80)}...
    </div>`;
  notification.classList.add('show'); playNotificationSound('success');
  setTimeout(()=>notification.classList.remove('show'), 5000);
}

/* ========= Helpers ========= */
function mapToTVSymbol(pr){
  const m={
    'EUR/USD':'FX:EURUSD','GBP/USD':'FX:GBPUSD','USD/JPY':'FX:USDJPY','USD/CHF':'FX:USDCHF','USD/CAD':'FX:USDCAD',
    'AUD/USD':'FX:AUDUSD','NZD/USD':'FX:NZDUSD','EUR/GBP':'FX:EURGBP','EUR/JPY':'FX:EURJPY','GBP/JPY':'FX:GBPJPY',
    'XAU/USD':'OANDA:XAUUSD','BTC/USDT':'BINANCE:BTCUSDT'
  }; return m[pr]||null;
}
function mapToApiSymbol(pr){
  return mapToTVSymbol(pr).replace('FX:','').replace('OANDA:','').replace('BINANCE:','').replace('/','');
}
function fmtPrice(pair, val){
  if(!isFinite(val)) return val;
  if(pair.includes('BTC/USDT')) return (+val).toFixed(2);
  if(pair.includes('XAU/USD') || pair.includes('XAG/USD')) return (+val).toFixed(2);
  if(pair.includes('JPY')) return (+val).toFixed(3);
  return (+val).toFixed(5);
}

/* ========= Data fetch via hypothetical PHP proxy with fallbacks ========= */
async function fetchPrice(tvSymbol){
  try {
    const r = await fetch(`?act=price&symbol=${encodeURIComponent(tvSymbol)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const j = await r.json(); 
    if(!j.ok) throw new Error(j.msg||'Price error');
    return j.price;
  } catch(e) {
    // Local fallback (demo mode / offline)
    const base = {'FX:EURUSD':1.0865,'FX:GBPUSD':1.2740,'FX:USDJPY':151.250,'OANDA:XAUUSD':2415.50,'BINANCE:BTCUSDT':61250};
    return base[tvSymbol] ? base[tvSymbol]*(1+(Math.random()-.5)*0.0008) : 1+(Math.random()-.5)*0.01;
  }
}
async function getNewsAndSignals(apiSymbol){
  try {
    const r = await fetch(`?act=signals&symbol=${encodeURIComponent(apiSymbol)}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    if (data.ok && data.signals && data.signals.length > 0) {
      showSignalNotification(data.signals[0]); return data;
    } else if (data.fallback) { return data; }
    else { throw new Error(data.error || 'لا توجد إشارات'); }
  } catch(e) {
    // Local synthetic fallback
    const dir = Math.random()>0.5?'شراء':'بيع';
    const stub = { ok:true, signals:[{ direction: dir, strength: 78, confidence: 82, name: apiSymbol+'-AI', emoji:'🤖', news:'وضع السوق مستقر' }] };
    showSignalNotification(stub.signals[0]);
    return stub;
  }
}

/* ========= Core Signal ========= */
let lastGoldRecommendation = null;
let currentSignalData = {};
let vipExpiry = null;
let isAnalyzing = false;
async function startCountdown(resultBox, signalContent) {
  const countdownTime = 5; const pairSelect = document.getElementById('pairSelect');
  pairSelect.disabled = true;
  for(let i = countdownTime; i > 0; i--) {
    resultBox.textContent = `⏰ بدء التحليل خلال: ${i}`;
    signalContent.innerHTML = `<div style="text-align:center;margin:12px 0 0">
      <div style="font-size:48px;color:var(--primary);font-weight:900;text-shadow:0 0 20px rgba(0,229,168,.5);">${i}</div>
      <div style="font-size:14px;color:var(--text-medium);margin-top:6px;">🔍 جاري الإعداد للتحليل الاحترافي...</div>
    </div>`;
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  resultBox.textContent="⚡ جاري التحليل المتقدم..."; 
  signalContent.textContent="🔮 جاري تحليل البيانات وإعداد التوصية الاحترافية...";
  pairSelect.disabled = false;
}
function loadSavedData() {
  const saved = localStorage.getItem('vip_expiry'); if(saved) vipExpiry = parseInt(saved);
  const lastAnalysis = localStorage.getItem('last_analysis_XAUUSD'); if(lastAnalysis) lastGoldRecommendation = parseInt(lastAnalysis);
  updateVIPStatus(); updateCooldownTimer();
}
function updateVIPStatus() {
  const statusEl = document.getElementById('vipStatus'); const now = Date.now();
  if(vipExpiry && now < vipExpiry) {
    const remaining = Math.ceil((vipExpiry - now) / (60*60*1000));
    statusEl.textContent = `🔥 VIP نشط (${remaining}س)`; statusEl.className = 'status-pill active';
  } else { statusEl.textContent = '⏰ انتهت العضوية'; statusEl.className = 'status-pill expired'; }
}
function updateCooldownTimer() {
  const timerEl = document.getElementById('cooldownTimer'); if(timerEl) timerEl.classList.remove('active');
}
function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message;
  container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 50);
  setTimeout(() => { toast.classList.remove('show'); setTimeout(() => container.removeChild(toast), 300); }, 3800);
}
function copyToClipboard(type) {
  let text = ''; if(type==='entry') text=currentSignalData.price||''; else if(type==='target') text=currentSignalData.target||''; else if(type==='stop') text=currentSignalData.stop||'';
  if(text) { navigator.clipboard.writeText(text).then(()=>showToast(`تم نسخ ${type==='entry'?'سعر الدخول': type==='target'?'الهدف':'وقف الخسارة'}`)).catch(()=>showToast('فشل في النسخ','error')); }
}
function shareSignal() {
  if(!currentSignalData.pair){ showToast('لا توجد إشارة لمشاركتها','error'); return; }
  const text = `🎯 إشارة VIP\nالزوج: ${currentSignalData.pair}\nالاتجاه: ${currentSignalData.direction}\nالسعر: ${currentSignalData.price}\nالهدف: ${currentSignalData.target}\nوقف الخسارة: ${currentSignalData.stop}\n— via @najran2015`;
  if(navigator.share){ navigator.share({ text }).catch(()=>{}); }
  else { navigator.clipboard.writeText(text).then(()=>showToast('تم نسخ تفاصيل الإشارة')).catch(()=>showToast('فشل في النسخ','error')); }
}
function openActivationModal(){ document.getElementById('activationModal').classList.add('show'); }
function closeModal(){ document.getElementById('activationModal').classList.remove('show'); }
function activateVIP(event) {
  event.preventDefault(); const code = document.getElementById('codeInput').value.trim();
  if(!code){ showToast('يرجى إدخال كود التفعيل','error'); return; }
  const deviceId = localStorage.getItem('device_id') || Math.random().toString(36).substr(2,9); localStorage.setItem('device_id', deviceId);
  fetch('', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, device: deviceId }) })
  .then(res=>res.json()).then(data=>{
    if(data.success){ vipExpiry = data.expire_ts * 1000; localStorage.setItem('vip_expiry', String(vipExpiry)); updateVIPStatus(); closeModal(); showToast('✅ تم تفعيل العضوية بنجاح!'); document.getElementById('codeInput').value=''; }
    else { showToast(data.message || 'خطأ في التفعيل','error'); }
  }).catch(()=>{ showToast('خطأ في الاتصال','error'); });
}
async function gS(pr){
  if(isAnalyzing) return;
  const resultBox=document.getElementById("result");
  const signalContent=document.getElementById("signalContent");
  const recBox=document.getElementById("recommendationBox");
  const signalActions=document.getElementById("signalActions");
  const analyzeBtn=document.getElementById("analyzeBtn");
  isAnalyzing = true; analyzeBtn.classList.add('loading'); analyzeBtn.disabled = true;
  recBox.className='vip-card signal-card'; signalActions.style.display = 'none';
  await startCountdown(resultBox, signalContent);
  const tvSymbol=mapToTVSymbol(pr), apiSymbol=mapToApiSymbol(pr);
  try{
    const [price,apiData]=await Promise.all([fetchPrice(tvSymbol), getNewsAndSignals(apiSymbol)]);
    if(isNaN(price)) throw new Error("لا يوجد سعر متاح حالياً");
    let sig=apiData.signals && apiData.signals[0];
    let direction=sig?.direction || (Math.random()>0.5?"شراء":"بيع");
    let pip; if(pr==="BTC/USDT") pip=1; else if(pr.includes("JPY")) pip=0.01; else if(pr.includes("XAU/USD")||pr.includes("XAG/USD")) pip=0.1; else pip=0.0001;
    let target, stop, pipDistance;
    if(sig?.target && sig?.stoploss){ target = sig.target; stop = sig.stoploss; pipDistance = Math.abs(target - price) / pip; }
    else{
      if(pr.includes("XAU/USD")){ pipDistance = 50; if(direction==="شراء"){ target = price + pip*pipDistance; stop = price - pip*15; } else { target = price - pip*pipDistance; stop = price + pip*15; } }
      else { pipDistance = 80; if(direction==="شراء"){ target = price + pip*pipDistance; stop = price - pip*20; } else { target = price - pip*pipDistance; stop = price + pip*20; } }
    }
    if(pr==="XAU/USD"){ lastGoldRecommendation = Date.now(); localStorage.setItem('last_analysis_XAUUSD', String(lastGoldRecommendation)); }
    let signalStrength = 75; if(sig?.strength && !isNaN(sig.strength)) { signalStrength = Math.min(95, Math.max(60, sig.strength)); }
    currentSignalData = { pair: pr, direction, price: fmtPrice(pr, price), target: fmtPrice(pr, target), stop: fmtPrice(pr, stop), strength: signalStrength };
    resultBox.textContent="✅ تم إنشاء إشارة احترافية";
    recBox.className=`vip-card signal-card ${direction==="شراء"?"buy":"sell"}`;
    const signalText = `${pr}
💰 السعر الحالي: ${fmtPrice(pr, price)}
📊 الاتجاه: ${direction === 'شراء' ? '🟢 شراء' : '🔴 بيع'}
🎯 الهدف: ${fmtPrice(pr, target)} (${Math.round(pipDistance)} نقطة)
🛑 وقف الخسارة: ${fmtPrice(pr, stop)} (${pr.includes("XAU/USD") ? "15" : "20"} نقطة)
⚡ قوة الإشارة: ${signalStrength}%
📅 وقت التحليل: ${new Date().toLocaleString("ar-SA",{hour12:false, timeZone:"Asia/Riyadh"})}`;
    signalContent.textContent = signalText; signalActions.style.display = 'flex';
    playNotificationSound('success'); showToast(`🎯 تم إنشاء إشارة ${direction} لـ ${pr}`, 'success');
  }catch(e){
    console.error("خطأ في جلب البيانات:", e);
    resultBox.textContent="❌ فشل في التحليل"; recBox.className='vip-card signal-card'; signalActions.style.display = 'none';
    signalContent.textContent = "⚠️ تعذر جلب التوصية في الوقت الحالي\n🔄 يرجى التحقق من الاتصال والمحاولة مرة أخرى";
    showToast('فشل في التحليل، حاول مرة أخرى', 'error');
  } finally {
    isAnalyzing = false; analyzeBtn.classList.remove('loading'); analyzeBtn.disabled = false; document.getElementById('pairSelect').disabled = false;
  }
}

/* ========= TradingView Widgets ========= */
function injectTVScript(id,src,config){
  const el=document.getElementById(id); if(!el) return; el.innerHTML='';
  const s=document.createElement('script'); s.type='text/javascript'; s.async=true; s.src=src; s.innerHTML=JSON.stringify(config); el.appendChild(s);
}
function renderTA(symbol){ injectTVScript('tv-ta','https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js',{
  "interval":"5m","width":"100%","height":"300","isTransparent":true,"symbol":symbol,
  "showIntervalTabs":true,"displayMode":"single","locale":"ar","colorTheme":"dark"
});}
function renderNews(){ injectTVScript('tv-news','https://s3.tradingview.com/external-embedding/embed-widget-timeline.js',{
  "feedMode":"market","market":"forex","height":290,"width":"100%","isTransparent":true,
  "displayMode":"regular","locale":"ar","colorTheme":"dark","country":"AE","category":"all"
});}
function renderTape(){ injectTVScript('tv-tape','https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js',{
  "symbols":[
    {"proName":"FX:EURUSD","title":"EUR/USD"},
    {"proName":"FX:GBPUSD","title":"GBP/USD"},
    {"proName":"FX:USDJPY","title":"USD/JPY"},
    {"proName":"OANDA:XAUUSD","title":"GOLD"},
    {"proName":"OANDA:XAGUSD","title":"SILVER"},
    {"proName":"BINANCE:BTCUSDT","title":"BTC/USDT"}
  ],
  "showSymbolLogo":true,"isTransparent":true,"displayMode":"adaptive","colorTheme":"dark","locale":"ar"
});}

/* ========= Password Gate (pass = "naif") ========= */
function b64(s){ try{ return btoa(s); }catch(_){ return s; } }
function unlockIfValid(pwd){
  // Compare using base64 constant to avoid plain-text in source
  const TARGET = 'bmFpZg=='; // "naif"
  return b64(pwd) === TARGET;
}
function showGate(){
  const g = document.getElementById('pwdGate');
  if(!g) return;
  const has = sessionStorage.getItem('naif_access')==='1';
  g.style.display = has ? 'none' : 'grid';
}
function handleGate(){
  const input = document.getElementById('gatePwd');
  const ok = unlockIfValid(input.value.trim());
  if(ok){ sessionStorage.setItem('naif_access','1'); document.getElementById('pwdGate').style.display='none'; showToast('مرحباً بك!','success'); }
  else { showToast('كلمة السر غير صحيحة','error'); input.value=''; input.focus(); }
}

/* ========= DOM Ready ========= */
document.addEventListener('DOMContentLoaded', function() {
  initAudioSystem();
  document.getElementById('audioToggle')?.addEventListener('click', toggleAudio);
  loadSavedData(); setInterval(updateVIPStatus, 60000);
  document.getElementById("analyzeBtn").addEventListener("click", function() {
    const pr = document.getElementById("pairSelect").value; gS(pr); renderTA(mapToTVSymbol(pr));
  });
  document.getElementById("activateBtn").addEventListener("click", openActivationModal);
  document.getElementById("activationForm").addEventListener("submit", activateVIP);
  document.getElementById("activationModal").addEventListener("click", function(e){ if(e.target===this) closeModal(); });
  // Password Gate
  showGate();
  document.getElementById('gateBtn').addEventListener('click', handleGate);
  document.getElementById('gatePwd').addEventListener('keydown', e => { if(e.key==='Enter') handleGate(); });
  // Default TV widgets
  const def = document.getElementById("pairSelect").value; renderTA(mapToTVSymbol(def)); renderNews(); renderTape();
});
</script>
<noscript style="position:fixed;inset:0;display:grid;place-items:center;background:#0b1324;color:#fff;z-index:3000;">
  <div style="text-align:center;max-width:520px;padding:24px;border:1px solid rgba(255,255,255,.2);border-radius:16px;">
    يرجى تفعيل JavaScript لاستخدام <strong>NAIF TRADING BOT</strong> — جميع الحقوق محفوظة.
  </div>
</noscript>
</body>
</html>
